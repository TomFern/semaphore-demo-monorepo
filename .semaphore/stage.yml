version: v1.0
name: 'Production deploy ${{ parameters.SVC }} to Heroku'
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: Stage
    task:
      jobs:
        - name: Deploy
          commands:
            - checkout
            - cd "services/$SVC"
            - git init
            - git config user.email "$HEROKU_EMAIL"
            - git config user.name "$HEROKU_EMAIL"
            - 'git config credential.helper ''!f() { printf "%s\n" "username=''$HEROKU_EMAIL''" "password=''$HEROKU_API_KEY''"; };f'''
            - 'heroku git:remote -a "monorepo-${SVC}-${ENV}"'
            - git add .
            - 'git commit -m "deploy monorepo-${SVC}-${ENV} to Heroku"'
            - git push heroku master --force
      secrets:
        - name: heroku-tomfern
      env_vars:
        - name: ENV
          value: staging
  - name: Smoke tests
    task:
      env_vars:
        - name: ENV
          value: staging
      jobs:
        - name: Test
          commands:
            - 'curl "https://monorepo-${SVC}-${ENV}.herokuapp.com"'
promotions:
  - name: Prod users
    pipeline_file: prod-deploy.yml
    parameters:
      env_vars:
        - required: true
          options:
            - users
            - billing
            - ui
          default_value: users
          description: What to deploy?
          name: SVC
    auto_promote:
      when: branch = 'master' AND result = 'passed' and change_in('/services/users/')
  - name: Prod billing
    pipeline_file: prod-deploy.yml
    auto_promote:
      when: branch = 'master' AND result = 'passed' and change_in('/services/billing/')
    parameters:
      env_vars:
        - required: true
          options:
            - users
            - billing
            - ui
          default_value: billing
          description: What to deploy?
          name: SVC
  - name: Prod ui
    pipeline_file: prod-deploy.yml
    auto_promote:
      when: branch = 'master' AND result = 'passed' and change_in('/services/ui/')
    parameters:
      env_vars:
        - required: true
          options:
            - users
            - billing
            - ui
          default_value: ui
          description: What to deploy?
          name: SVC
